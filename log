Entware
-------
USB - EXT2,SWAP
FTP - CREATE FOLDER install
COPY http://bin.entware.net/mipselsf-k3.4/installer/EN_mipsel-installer.tar.gz
APPLY IN ROUTER

ip:222 - root:keenetic
CHANGE PASS passwd

---

nano /opt/etc/init.d/Sxxname   // xx - порядок, автостарт
#!/bin/sh
...

---

opkg update

opkg install nano nginx bzip2 tar openssl-util wget curl

opkg install php7 php7-cli php7-fastcgi \
php7-mod-curl php7-mod-zip php7-mod-json \
php7-mod-xml php7-mod-xmlreader php7-mod-xmlwriter php7-mod-simplexml \
php7-mod-sockets php7-mod-session php7-mod-openssl \
php7-mod-hash php7-mod-dom php7-mod-exif php7-mod-iconv php7-mod-mbstring \
php7-mod-ctype php7-mod-fileinfo php7-mod-gd php7-mod-gettext \
php7-mod-pdo php7-mod-pdo-mysql php7-mod-mysqli \
php7-mod-sqlite3 php7-mod-pdo-sqlite \
php7-pecl-mcrypt

ln -s /opt/bin/php-cli /opt/bin/php

sed -i "s|memory_limit = .*|memory_limit = 32M|" /opt/etc/php.ini
sed -i "s|log_errors = .*|log_errors = On|" /opt/etc/php.ini
sed -i "s|;error_log = .*|error_log = /opt/var/log/php_errors.log|" /opt/etc/php.ini
sed -i "s|post_max_size = .*|post_max_size = 512M|" /opt/etc/php.ini
sed -i "s|upload_max_filesize = .*|upload_max_filesize = 512M|" /opt/etc/php.ini

sed -i "s|max_execution_time = .*|max_execution_time = 300|" /opt/etc/php.ini
sed -i "s|cgi.fix_pathinfo=.*|cgi.fix_pathinfo=0|" /opt/etc/php.ini

sed -i "s|doc_root = .*|doc_root = \\\"/opt/share/www\\\"|" /opt/etc/php.ini

nano /opt/etc/php.ini   // добавить в конец
[APC]
apc.enabled = 1
apc.shm_segments = 1
apc.shm_size = 4M

[Date]
date.timezone = Asia/Yekaterinburg

[Pdo_mysql]
pdo_mysql.cache_size = 2000
pdo_mysql.default_socket = /opt/var/run/mysqld.sock

[MySQL]
mysql.allow_local_infile = On
mysql.allow_persistent = On
mysql.cache_size = 2000
mysql.max_persistent = -1
mysql.max_links = -1
mysql.default_port =
mysql.default_socket =
mysql.default_host =
mysql.default_user =
mysql.default_password =
mysql.connect_timeout = 60
mysql.trace_mode = Off

[Session]
session.save_handler = files
session.save_path = "/opt/tmp"
session.use_cookies = 1
;session.cookie_secure =
session.use_only_cookies = 1
session.name = PHPSESSID
session.auto_start = 0
session.cookie_lifetime = 0
session.cookie_path = /
session.cookie_domain =
session.cookie_httponly =
session.serialize_handler = php
session.gc_probability = 1
session.gc_divisor = 100
session.gc_maxlifetime = 1440
session.bug_compat_42 = On
session.bug_compat_warn = On
session.referer_check =
session.entropy_length = 0
;session.entropy_file = /dev/urandom
session.entropy_file =
;session.entropy_length = 16
session.cache_limiter = nocache
session.cache_expire = 180
session.use_trans_sid = 0
session.hash_function = 0
session.hash_bits_per_character = 4
url_rewriter.tags = "a=href,area=href,frame=src,input=src,form=,fieldset="

[soap]
soap.wsdl_cache_enabled = 1
soap.wsdl_cache_dir = "/opt/tmp"
soap.wsdl_cache_ttl = 86400
soap.wsdl_cache_limit = 5

[ldap]
ldap.max_links = -1

[opcache]
opcache.max_accelerated_files = 200
opcache.enable_cli = 1
opcache.enable = 1



nano /opt/etc/init.d/S79php-fcgi && chmod +x /opt/etc/init.d/S79php-fcgi
#!/bin/sh
export PHP_FCGI_CHILDREN=''
ENABLED=yes
PROCS=php-fcgi
ARGS="-b /opt/var/run/php-fcgi.sock &"
PREARGS=""
DESC=$PROCS
PATH=/opt/bin:/opt/sbin:/opt/usr/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
. /opt/etc/init.d/rc.func


/opt/etc/init.d/S79php-fcgi start && \
/opt/etc/init.d/S79php-fcgi check

---

opkg install redis-cli redis-server php7-pecl-redis

sed -i "s|port .*|port 0|" /opt/etc/redis.conf && \
sed -i "s|# unixsocket .*|unixsocket /opt/var/run/redis.sock|" /opt/etc/redis.conf && \
sed -i "s|# unixsocketperm .*|unixsocketperm 770|" /opt/etc/redis.conf

/opt/etc/init.d/S70redis start && \
/opt/etc/init.d/S70redis check

redis-cli -s /opt/var/run/redis.sock   // проверка работы сокета PING

---

mkdir /opt/share/www && cd /opt/share/www
wget https://download.nextcloud.com/server/releases/nextcloud-17.0.1.tar.bz2 --no-check-certificate
bzip2 -cd nextcloud-17.0.1.tar.bz2 | tar -xv && rm ./nextcloud-17.0.1.tar.bz2

ln -s /opt/share/www/nextcloud /opt/share/www/cloud
ln -s /opt/share/www/nextcloud/occ /opt/bin/occ

mkdir /opt/share/www/nextcloud/apps2
mkdir /opt/share/www/nextcloud/data

chown -R nobody:nobody /opt/share/www/*
chmod -R 755 /opt/share/www/*

---

opkg install mariadb-server mariadb-client-extra

sh -c 'cat <<EOT > /opt/etc/mysql/my.cnf
[server]
skip-name-resolve = 1
# innodb_buffer_pool_size = 128M
# innodb_buffer_pool_instances = 1
# innodb_flush_log_at_trx_commit = 2
# innodb_log_buffer_size = 32M
# innodb_max_dirty_pages_pct = 90
query_cache_type = 1
query_cache_limit = 2M
query_cache_min_res_unit = 2k
query_cache_size = 64M
tmp_table_size = 64M
max_heap_table_size = 64M
slow-query-log = 1
slow-query-log-file = /opt/var/log/mysql/slow.log
long_query_time = 1

[client-server]
!includedir /opt/etc/mysql/conf.d/

[client]
default-character-set = utf8mb4

[mysqld]
character-set-server = utf8mb4
collation-server = utf8mb4_general_ci
transaction_isolation = READ-COMMITTED
# log-bin = mysql-bin
binlog_format = ROW
skip-innodb
default-storage-engine = MyISAM
# innodb_large_prefix = on
# innodb_file_format = barracuda
# innodb_file_per_table = 1
EOT' && \
nano /opt/etc/mysql/my.cnf

mysql_install_db

/opt/etc/init.d/S70mysqld start
/opt/etc/init.d/S70mysqld status
/opt/bin/mysqladmin -u root password 'AV41neMG'

sh -c "cat <<EOT > ~/nextcloud.sql
CREATE DATABASE IF NOT EXISTS nextcloud CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
CREATE USER 'cloud'@'127.0.0.1' IDENTIFIED BY 'AV41neMG';
GRANT ALL PRIVILEGES ON \\\`nextcloud\\\`.* TO 'cloud'@'127.0.0.1';
FLUSH PRIVILEGES;
EOT" && \
nano ~/nextcloud.sql

sh -c 'mysql -uroot -p"AV41neMG" < ~/nextcloud.sql'
rm -rf ~/nextcloud.sql

/opt/etc/init.d/S70mysqld restart
/opt/etc/init.d/S70mysqld status

---

sh -c "cat <<EOT > /opt/etc/nginx/fastcgi_params
fastcgi_param  QUERY_STRING       \\\$query_string;
fastcgi_param  REQUEST_METHOD     \\\$request_method;
fastcgi_param  CONTENT_TYPE       \\\$content_type;
fastcgi_param  CONTENT_LENGTH     \\\$content_length;

fastcgi_param  SCRIPT_FILENAME    \\\$document_root\\\$fastcgi_script_name;
fastcgi_param  SCRIPT_NAME        \\\$fastcgi_script_name;
fastcgi_param  PATH_INFO          \\\$fastcgi_path_info;
fastcgi_param  PATH_TRANSLATED    \\\$document_root\\\$fastcgi_path_info;
fastcgi_param  REQUEST_URI        \\\$request_uri;
fastcgi_param  DOCUMENT_URI       \\\$document_uri;
fastcgi_param  DOCUMENT_ROOT      \\\$document_root;
fastcgi_param  SERVER_PROTOCOL    \\\$server_protocol;
fastcgi_param  REQUEST_SCHEME     \\\$scheme;

fastcgi_param  GATEWAY_INTERFACE  CGI/1.1;
fastcgi_param  SERVER_SOFTWARE    nginx/\\\$nginx_version;

fastcgi_param  REMOTE_ADDR        \\\$remote_addr;
fastcgi_param  REMOTE_PORT        \\\$remote_port;
fastcgi_param  SERVER_ADDR        \\\$server_addr;
fastcgi_param  SERVER_PORT        \\\$server_port;
fastcgi_param  SERVER_NAME        \\\$server_name;

fastcgi_param  HTTPS              \\\$https if_not_empty;
fastcgi_param  REDIRECT_STATUS    200;
EOT" && \
nano /opt/etc/nginx/fastcgi_params

---

mkdir /opt/etc/nginx/conf.d

cat /dev/null > /opt/etc/nginx/nginx.conf && \
nano /opt/etc/nginx/nginx.conf
user nobody;
worker_processes auto;

# error_log /opt/var/log/nginx/error.log;
# error_log /opt/var/log/nginx/error.log notice;
# error_log /opt/var/log/nginx/error.log info;

pid /opt/var/run/nginx.pid;

events {
  worker_connections 64;
  use epoll;
}

http {

  # Basic settings
  # ----------

  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  reset_timedout_connection on;
  keepalive_requests 1000;
  keepalive_timeout 65;
  types_hash_max_size 2048;
  server_tokens off;
  send_timeout 30s;
  server_names_hash_max_size 4096;

  ssl_session_tickets off;
  
  # Common limits
  # ----------

  client_max_body_size 100m;
  client_body_buffer_size 1m;
  client_header_timeout 3m;
  client_body_timeout 3m;

  # client_body_temp_path /opt/var/nginx/client_body_temp;

  proxy_connect_timeout 60s;
  proxy_send_timeout 60s;
  proxy_read_timeout 60s;

  proxy_buffer_size 4k;
  proxy_buffers 8 16k;
  proxy_busy_buffers_size 64k;
  proxy_temp_file_write_size 64k;

  # proxy_temp_path /opt/var/nginx/proxy_temp;

  include mime.types;
  default_type application/octet-stream;

  # Logs format
  # ----------

  log_format main '$remote_addr - $host [$time_local] "$request" '
                  '$status $body_bytes_sent "$http_referer" '
                  '"$http_user_agent" "$http_x_forwarded_for"'
                  'rt=$request_time ut=$upstream_response_time '
                  'cs=$upstream_cache_status';

  log_format cache '$remote_addr - $host [$time_local] "$request" $status '
                   '$body_bytes_sent "$http_referer" '
                   'rt=$request_time ut=$upstream_response_time '
                   'cs=$upstream_cache_status';

  access_log /opt/var/log/nginx/access.log main;

  # GZip config
  # ----------

  # gzip on;
  # gunzip on;
  # gzip_static on;
  # gzip_types text/css text/xml application/javascript application/atom+xml  application/rss+xml text/plain image$
  # gzip_comp_level 9;
  # gzip_buffers 16 8k;
  # gzip_proxied expired no-cache no-store private auth;
  # gzip_min_length 1;
  # gzip_disable "MSIE [1-6].(?!.*SV1)";
  # gzip_vary on;

  # Cache config
  # ----------

  # proxy_cache_valid 1m;

  # PHP
  # ----------
  
  upstream php-handler {
    server unix:/opt/var/run/php-fcgi.sock;
  }

  # Virtual host config
  # ----------

  include /opt/etc/nginx/conf.d/*.conf;
}



nano /opt/etc/nginx/conf.d/default.conf
server {
  listen 8000 default_server;
  server_name _;  
  root /opt/share/www;
  index index.php index.html index.htm;

  location = /robots.txt {
    allow all;
    access_log off;
    log_not_found off;
  }
  location = /favicon.ico {
    access_log off;
    log_not_found off;
  }
  location / {
    try_files $uri $uri/ =404;
  }
  location /stub_status {
    stub_status;
  }  
  error_page 500 502 503 504 /50x.html;
    location = /50x.html {
    root html;
  }
  location ~ [^/]\.php(/|$) {
    fastcgi_split_path_info ^(.+?\.php)(/.*)$;
    if (!-f $document_root$fastcgi_script_name) {
      return 404;
    }
    fastcgi_pass php-handler;
    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include fastcgi_params;
    fastcgi_param MOD_X_ACCEL_REDIRECT_ENABLED on;
  }
  location ~ /\.ht {
    deny all;
  }
}


sh -c 'echo "Alive!" > /opt/share/www/index.html'
sh -c 'echo "<?php phpinfo(); ?>" > /opt/share/www/info.php'
nano /opt/share/www/head.php
<?php
header( 'Content-Type: text/plain' );
echo 'Host: ' . $_SERVER['HTTP_HOST'] . "\n";
echo 'Remote Address: ' . $_SERVER['REMOTE_ADDR'] . "\n";
echo 'X-Forwarded-For: ' . $_SERVER['HTTP_X_FORWARDED_FOR'] . "\n";
echo 'X-Forwarded-Proto: ' . $_SERVER['HTTP_X_FORWARDED_PROTO'] . "\n";
echo 'Server Address: ' . $_SERVER['SERVER_ADDR'] . "\n";
echo 'Server Port: ' . $_SERVER['SERVER_PORT'] . "\n\n";
?>



nginx -t

/opt/etc/init.d/S80nginx start && \
/opt/etc/init.d/S80nginx test


/opt/etc/init.d/S79php-fcgi restart && /opt/etc/init.d/S80nginx restart
